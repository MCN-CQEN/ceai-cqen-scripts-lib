# name: Deploy Keycloak Realm
# description: |
#   D√©ploie ou met √† jour un realm Keycloak √† partir d‚Äôun fichier JSON.
#   V√©rifie si le realm existe d√©j√†, le cr√©e sinon, ou le met √† jour si n√©cessaire.

# inputs:
#   realm-file:
#     description: "Chemin du fichier JSON du realm √† d√©ployer"
#     required: true
#   keycloak_url:
#     description: "Keycloak URL"
#     required: false
#   keycloak_username:
#     description: "Keycloak username"
#     required: true
#   keycloak_password:
#     description: "Keycloak password"
#     required: true

# runs:
#   using: "composite" 
#   steps:
#     - name: Checkout repository
#       uses: actions/checkout@v4

#     - name: Install jq and curl
#       run: sudo apt-get update && sudo apt-get install -y jq curl
#       shell: bash

#     - name: Debug inputs
#       run: |
#         echo "Valeur re√ßue pour realm-file : '${{ inputs.realm-file }}'"
#         echo "Chemin absolu : $(pwd)/${{ inputs.realm-file }}"
#         ls -al $(dirname "${{ inputs.realm-file }}") || echo "R√©pertoire introuvable"
#         if [ -f "${{ inputs.realm-file }}" ]; then
#           echo "‚úÖ Fichier trouv√© :"
#           head -n 10 "${{ inputs.realm-file }}"
#         else
#           echo "‚ùå Fichier introuvable √† l‚Äôendroit attendu."
#         fi
#       shell: bash

#     - name: Valider le fichier JSON
#       env:
#         REALM_FILE: ${{ inputs.realm-file }}
#       run: |
#         if [ ! -f "$inputs.realm-file" ]; then
#           echo "Fichier $inputs.realm-file introuvable"
#           exit 1
#         fi
          
#         if ! jq empty "$inputs.realm-file"; then
#           echo "Fichier JSON invalide"
#           exit 1
#         fi
          
#         REALM_NAME=$(jq -r '.realm // empty' "$inputs.realm-file")
#         if [ -z "$REALM_NAME" ]; then
#           echo "Le champ 'realm' est manquant"
#           exit 1
#         fi
          
#         echo "REALM_NAME=$REALM_NAME" >> $GITHUB_ENV
#         echo "Realm valid√©: $REALM_NAME"
#       shell: bash

#     - name: Extraction du realm name
#       id: realm
#       run: |
#         REALM_NAME=$(jq -r '.realm' "$inputs.realm-file")
#         echo "name=$REALM_NAME" >> $GITHUB_OUTPUT
#         echo "Realm cible: $REALM_NAME"
#       shell: bash

#     - name: Get access token
#       id: get-token
#       run: |
#         TOKEN=$(curl -s -X POST "$keycloak_url/realms/master/protocol/openid-connect/token" \
#           -H "Content-Type: application/x-www-form-urlencoded" \
#           -d "client_id=admin-cli" \
#           -d "username=$keycloak_username" \
#           -d "password=$keycloak_password" \
#           -d "grant_type=password" | jq -r .access_token)
#         echo "token=$TOKEN" >> $GITHUB_OUTPUT
#       shell: bash 

#     - name: Check if realm exists
#       id: check-realm
#       run: |
#         STATUS=$(curl -s -o existing_realm.json -w "%{http_code}" \
#           -H "Authorization: Bearer ${{ steps.get-token.outputs.token }}" \
#           "$keycloak_url/admin/realms/$REALM_NAME")
#         echo "status=$STATUS" >> $GITHUB_OUTPUT
#       shell: bash

#     - name: Debug realm status
#       run: |
#         echo "Realm check status: ${{ steps.check-realm.outputs.status }}"
#         if [ -f existing_realm.json ]; then
#           cat existing_realm.json | jq .
#         fi
#       shell: bash

#     - name: Create new realm
#       if: steps.check-realm.outputs.status == '404'
#       run: |
#         echo "Cr√©ation du nouveau realm: $REALM_NAME"
            
#         RESPONSE=$(curl -s -w "HTTPSTATUS:%{http_code}" -X POST \
#           "$keycloak_url/admin/realms" \
#           -H "Authorization: Bearer ${{ steps.get-token.outputs.token }}" \
#           -H "Content-Type: application/json" \
#           --data-binary @"$inputs.realm-file")
            
#         HTTP_CODE=$(echo $RESPONSE | tr -d '\n' | sed -e 's/.*HTTPSTATUS://')
#         BODY=$(echo $RESPONSE | sed -e 's/HTTPSTATUS:.*//g')
            
#         if [ "$HTTP_CODE" -eq 201 ] || [ "$HTTP_CODE" -eq 204 ]; then
#           echo "Realm cr√©√© avec succ√®s"
#         else
#           echo "√âchec de la cr√©ation du realm (HTTP $HTTP_CODE)"
#           echo "$BODY"
#           exit 1
#         fi
#       shell: bash

#     - name: Update existing realm
#       if: steps.check-realm.outputs.status == '200'
#       run: |
#         echo "Comparaison et mise √† jour du realm existant"

#         jq 'del(.id, .notBefore, .revokeRefreshToken, .refreshTokenMaxReuse, .accessTokenLifespan, .accessTokenLifespanForImplicitFlow, .ssoSessionIdleTimeout, .ssoSessionMaxLifespan, .offlineSessionIdleTimeout, .accessCodeLifespan, .accessCodeLifespanUserAction, .accessCodeLifespanLogin, .actionTokenGeneratedByAdminLifespan, .actionTokenGeneratedByUserLifespan, .oauth2DeviceCodeLifespan, .oauth2DevicePollingInterval)' existing_realm.json > existing_clean.json
          
#         jq 'del(.id, .notBefore, .revokeRefreshToken, .refreshTokenMaxReuse, .accessTokenLifespan, .accessTokenLifespanForImplicitFlow, .ssoSessionIdleTimeout, .ssoSessionMaxLifespan, .offlineSessionIdleTimeout, .accessCodeLifespan, .accessCodeLifespanUserAction, .accessCodeLifespanLogin, .actionTokenGeneratedByAdminLifespan, .actionTokenGeneratedByUserLifespan, .oauth2DeviceCodeLifespan, .oauth2DevicePollingInterval)' "$inputs.realm-file" > new_clean.json


#         if ! diff -q existing_clean.json new_clean.json >/dev/null 2>&1; then
#           echo "Diff√©rences d√©tect√©es, mise √† jour en cours..."

#           curl -s -X PUT "$keycloak_url/admin/realms/$REALM_NAME" \
#               -H "Authorization: Bearer ${{ steps.get-token.outputs.token }}" \
#               -H "Content-Type: application/json" \
#               --data-binary @"$inputs.realm-file"
#         else
#           echo "Aucune modification d√©tect√©e, realm inchang√©"
#         fi
#       shell: bash

#     - name: Verify deployment
#       run: |
#         echo "V√©rification finale du d√©ploiement"
            
#         STATUS=$(curl -s -w "%{http_code}" -o /dev/null \
#           -H "Authorization: Bearer ${{ steps.get-token.outputs.token }}" \
#           "$keycloak_url/admin/realms/$REALM_NAME")
            
#         if [ "$STATUS" = "200" ]; then
#           echo "D√©ploiement v√©rifi√© avec succ√®s"
#           echo "Realm '$REALM_NAME' est accessible"
#         else
#           echo "√âchec de la v√©rification (HTTP $STATUS)"
#           exit 1
#         fi
#       shell: bash

#     - name: Cleanup temporary files
#       if: always()
#       run: |
#         rm -f existing_realm.json existing_clean.json new_clean.json
#       shell: bash

name: Deploy Keycloak Realm
description: |
  D√©ploie ou met √† jour un realm Keycloak √† partir d‚Äôun fichier JSON.
  V√©rifie si le realm existe d√©j√†, le cr√©e sinon, ou le met √† jour si n√©cessaire.

inputs:
  realm-file:
    description: "Chemin du fichier JSON du realm √† d√©ployer (relatif √† la racine du repo)"
    required: true
  keycloak_url:
    description: "URL du serveur Keycloak"
    required: true
  keycloak_username:
    description: "Nom d'utilisateur Keycloak (admin)"
    required: true
  keycloak_password:
    description: "Mot de passe Keycloak (admin)"
    required: true

runs:
  using: "composite"
  steps:
    # -------------------------------------------------------------
    # √âtape 1 : Checkout du d√©p√¥t (pour acc√©der au fichier realm)
    # -------------------------------------------------------------
    - name: Checkout repository
      uses: actions/checkout@v4

    # -------------------------------------------------------------
    # √âtape 2 : Installation des outils requis
    # -------------------------------------------------------------
    - name: Install jq and curl
      run: sudo apt-get update && sudo apt-get install -y jq curl
      shell: bash

    # -------------------------------------------------------------
    # √âtape 3 : R√©solution du chemin absolu du fichier realm
    # -------------------------------------------------------------
    - name: Resolve realm file path
      id: resolve
      run: |
        REALM_PATH="${{ github.workspace }}/${{ inputs.realm-file }}"
        echo "üîç Chemin r√©solu : $REALM_PATH"

        if [ ! -f "$REALM_PATH" ]; then
          echo "‚ùå Fichier introuvable : $REALM_PATH"
          echo "Contenu du r√©pertoire courant :"
          ls -R "$(dirname "$REALM_PATH")" || true
          exit 1
        fi

        echo "‚úÖ Fichier trouv√© : $REALM_PATH"
        echo "REALM_FILE=$REALM_PATH" >> $GITHUB_ENV
      shell: bash

    # -------------------------------------------------------------
    # √âtape 4 : Debug (affiche le contenu et v√©rifie l'arriv√©e du fichier)
    # -------------------------------------------------------------
    - name: Debug realm file
      run: |
        echo "üß© V√©rification de la pr√©sence du fichier realm"
        echo "Chemin absolu : $REALM_FILE"
        ls -al "$(dirname "$REALM_FILE")"
        echo "Contenu du fichier :"
        head -n 20 "$REALM_FILE"
      shell: bash

    # -------------------------------------------------------------
    # √âtape 5 : Validation du fichier JSON
    # -------------------------------------------------------------
    - name: Validate realm JSON
      run: |
        if ! jq empty "$REALM_FILE"; then
          echo "‚ùå Fichier JSON invalide"
          exit 1
        fi

        REALM_NAME=$(jq -r '.realm // empty' "$REALM_FILE")
        if [ -z "$REALM_NAME" ]; then
          echo "‚ùå Le champ 'realm' est manquant dans le JSON"
          exit 1
        fi

        echo "‚úÖ Realm valid√© : $REALM_NAME"
        echo "REALM_NAME=$REALM_NAME" >> $GITHUB_ENV
      shell: bash

    # -------------------------------------------------------------
    # √âtape 6 : Obtenir un token d'acc√®s admin
    # -------------------------------------------------------------
    - name: Get access token
      id: get-token
      run: |
        TOKEN=$(curl -s -X POST "$KEYCLOAK_URL/realms/master/protocol/openid-connect/token" \
          -H "Content-Type: application/x-www-form-urlencoded" \
          -d "client_id=admin-cli" \
          -d "username=$KEYCLOAK_USERNAME" \
          -d "password=$KEYCLOAK_PASSWORD" \
          -d "grant_type=password" | jq -r .access_token)

        if [ -z "$TOKEN" ] || [ "$TOKEN" = "null" ]; then
          echo "‚ùå Impossible d'obtenir un token"
          exit 1
        fi

        echo "token=$TOKEN" >> $GITHUB_OUTPUT
        echo "‚úÖ Token r√©cup√©r√© avec succ√®s"
      shell: bash
      env:
        KEYCLOAK_URL: ${{ inputs.keycloak_url }}
        KEYCLOAK_USERNAME: ${{ inputs.keycloak_username }}
        KEYCLOAK_PASSWORD: ${{ inputs.keycloak_password }}

    # -------------------------------------------------------------
    # √âtape 7 : V√©rifie si le realm existe
    # -------------------------------------------------------------
    - name: Check if realm exists
      id: check-realm
      run: |
        STATUS=$(curl -s -o existing_realm.json -w "%{http_code}" \
          -H "Authorization: Bearer ${{ steps.get-token.outputs.token }}" \
          "$KEYCLOAK_URL/admin/realms/$REALM_NAME")

        echo "status=$STATUS" >> $GITHUB_OUTPUT
        echo "üìÑ Statut du realm : $STATUS"
      shell: bash
      env:
        KEYCLOAK_URL: ${{ inputs.keycloak_url }}

    # -------------------------------------------------------------
    # √âtape 8 : Cr√©er le realm s‚Äôil n‚Äôexiste pas
    # -------------------------------------------------------------
    - name: Create new realm
      if: steps.check-realm.outputs.status == '404'
      run: |
        echo "üÜï Cr√©ation du nouveau realm : $REALM_NAME"

        RESPONSE=$(curl -s -w "HTTPSTATUS:%{http_code}" -X POST \
          "$KEYCLOAK_URL/admin/realms" \
          -H "Authorization: Bearer ${{ steps.get-token.outputs.token }}" \
          -H "Content-Type: application/json" \
          --data-binary @"$REALM_FILE")

        HTTP_CODE=$(echo "$RESPONSE" | tr -d '\n' | sed -e 's/.*HTTPSTATUS://')
        BODY=$(echo "$RESPONSE" | sed -e 's/HTTPSTATUS:.*//g')

        if [ "$HTTP_CODE" -eq 201 ] || [ "$HTTP_CODE" -eq 204 ]; then
          echo "‚úÖ Realm cr√©√© avec succ√®s"
        else
          echo "‚ùå √âchec de la cr√©ation (HTTP $HTTP_CODE)"
          echo "$BODY"
          exit 1
        fi
      shell: bash
      env:
        KEYCLOAK_URL: ${{ inputs.keycloak_url }}

    # -------------------------------------------------------------
    # √âtape 9 : Mettre √† jour le realm existant
    # -------------------------------------------------------------
    - name: Update existing realm
      if: steps.check-realm.outputs.status == '200'
      run: |
        echo "üõ†Ô∏è  Comparaison et mise √† jour du realm existant..."

        jq 'del(.id, .notBefore, .accessTokenLifespan, .ssoSessionIdleTimeout, .ssoSessionMaxLifespan)' existing_realm.json > existing_clean.json
        jq 'del(.id, .notBefore, .accessTokenLifespan, .ssoSessionIdleTimeout, .ssoSessionMaxLifespan)' "$REALM_FILE" > new_clean.json

        if ! diff -q existing_clean.json new_clean.json >/dev/null 2>&1; then
          echo "üîÑ Diff√©rences d√©tect√©es, mise √† jour en cours..."
          curl -s -X PUT "$KEYCLOAK_URL/admin/realms/$REALM_NAME" \
              -H "Authorization: Bearer ${{ steps.get-token.outputs.token }}" \
              -H "Content-Type: application/json" \
              --data-binary @"$REALM_FILE"
        else
          echo "‚úÖ Aucune modification d√©tect√©e"
        fi
      shell: bash
      env:
        KEYCLOAK_URL: ${{ inputs.keycloak_url }}

    # -------------------------------------------------------------
    # √âtape 10 : V√©rification finale
    # -------------------------------------------------------------
    - name: Verify deployment
      run: |
        STATUS=$(curl -s -w "%{http_code}" -o /dev/null \
          -H "Authorization: Bearer ${{ steps.get-token.outputs.token }}" \
          "$KEYCLOAK_URL/admin/realms/$REALM_NAME")

        if [ "$STATUS" = "200" ]; then
          echo "‚úÖ D√©ploiement v√©rifi√© avec succ√®s : Realm '$REALM_NAME'"
        else
          echo "‚ùå √âchec de la v√©rification (HTTP $STATUS)"
          exit 1
        fi
      shell: bash
      env:
        KEYCLOAK_URL: ${{ inputs.keycloak_url }}

    # -------------------------------------------------------------
    # √âtape 11 : Nettoyage
    # -------------------------------------------------------------
    - name: Cleanup temporary files
      if: always()
      run: rm -f existing_realm.json existing_clean.json new_clean.json
      shell: bash