name: Deploy Keycloak Realm
description: |
  D√©ploie ou met √† jour un realm Keycloak √† partir d‚Äôun fichier JSON.
  V√©rifie si le realm existe d√©j√†, le cr√©e sinon, ou le met √† jour si n√©cessaire.

inputs:
  realm-file:
    description: "Chemin du fichier JSON du realm √† d√©ployer (relatif √† la racine du repo)"
    required: true
  keycloak_url:
    description: "URL du serveur Keycloak"
    required: true
  keycloak_username:
    description: "Nom d'utilisateur Keycloak (admin)"
    required: true
  keycloak_password:
    description: "Mot de passe Keycloak (admin)"
    required: true

runs:
  using: "composite"
  steps:
    # -------------------------------------------------------------
    # √âtape 1 : Checkout du d√©p√¥t (pour acc√©der au fichier realm)
    # -------------------------------------------------------------
    - name: Checkout repository
      uses: actions/checkout@v4

    # -------------------------------------------------------------
    # √âtape 2 : Installation des outils requis
    # -------------------------------------------------------------
    - name: Install jq and curl
      run: sudo apt-get update && sudo apt-get install -y jq curl
      shell: bash

    # -------------------------------------------------------------
    # √âtape 3 : R√©solution du chemin absolu du fichier realm
    # -------------------------------------------------------------
    - name: Resolve realm file path
      id: resolve
      run: |
        REALM_PATH="${{ github.workspace }}/${{ inputs.realm-file }}"
        echo "Chemin r√©solu : $REALM_PATH"

        if [ ! -f "$REALM_PATH" ]; then
          echo "Fichier introuvable : $REALM_PATH"
          echo "Contenu du r√©pertoire courant :"
          ls -R "$(dirname "$REALM_PATH")" || true
          exit 1
        fi

        echo "Fichier trouv√© : $REALM_PATH"
        echo "REALM_FILE=$REALM_PATH" >> $GITHUB_ENV
      shell: bash

    # -------------------------------------------------------------
    # √âtape 4 : Debug (affiche le contenu et v√©rifie l'arriv√©e du fichier)
    # -------------------------------------------------------------
    - name: Debug realm file
      run: |
        echo "V√©rification de la pr√©sence du fichier realm"
        echo "Chemin absolu : $REALM_FILE"
        ls -al "$(dirname "$REALM_FILE")"
        echo "Contenu du fichier :"
        head -n 20 "$REALM_FILE"
      shell: bash

    # -------------------------------------------------------------
    # √âtape 5 : Validation du fichier JSON
    # -------------------------------------------------------------
    - name: Validate realm JSON
      run: |
        if ! jq empty "$REALM_FILE"; then
          echo "Fichier JSON invalide"
          exit 1
        fi

        REALM_NAME=$(jq -r '.realm // empty' "$REALM_FILE")
        if [ -z "$REALM_NAME" ]; then
          echo "Le champ 'realm' est manquant dans le JSON"
          exit 1
        fi

        echo "Realm valid√© : $REALM_NAME"
        echo "REALM_NAME=$REALM_NAME" >> $GITHUB_ENV
      shell: bash

    # -------------------------------------------------------------
    # √âtape 6 : Obtenir un token d'acc√®s admin
    # -------------------------------------------------------------

    - name: Get Keycloak token
      shell: bash
      env:
        KEYCLOAK_URL: ${{ secrets.KEYCLOAK_URL }}
        KEYCLOAK_USERNAME: ${{ secrets.KEYCLOAK_USERNAME }}
        KEYCLOAK_PASSWORD: ${{ secrets.KEYCLOAK_PASSWORD }}
      run: |
        set -euo pipefail
    
        : "${KEYCLOAK_URL:?KEYCLOAK_URL manquant}"
        : "${KEYCLOAK_USERNAME:?KEYCLOAK_USERNAME manquant}"
        : "${KEYCLOAK_PASSWORD:?KEYCLOAK_PASSWORD manquant}"
    
        RESPONSE=$(curl -sS -X POST \
          "${KEYCLOAK_URL%/}/realms/master/protocol/openid-connect/token" \
          -H "Content-Type: application/x-www-form-urlencoded" \
          --data-urlencode "client_id=admin-cli" \
          --data-urlencode "username=${KEYCLOAK_USERNAME}" \
          --data-urlencode "password=${KEYCLOAK_PASSWORD}" \
          --data-urlencode "grant_type=password")
    
        # V√©rifie si la r√©ponse contient un access_token
        if ! TOKEN=$(echo "$RESPONSE" | jq -r '.access_token // empty'); then
          echo "Erreur: r√©ponse non JSON"
          echo "$RESPONSE" | head -c 500
          exit 1
        fi
    
        if [[ -z "$TOKEN" ]]; then
          echo "Aucun access_token trouv√© dans la r√©ponse :"
          echo "$RESPONSE" | head -c 500
          exit 1
        fi
    
        echo "Token r√©cup√©r√© (longueur=${#TOKEN})."
        echo "TOKEN=$TOKEN" >> $GITHUB_ENV
    # - name: Get access token
    #   id: get-token
    #   run: |
    #     TOKEN=$(curl -s -X POST "$KEYCLOAK_URL/realms/master/protocol/openid-connect/token" \
    #       -H "Content-Type: application/x-www-form-urlencoded" \
    #       --data-urlencode "client_id=admin-cli" \
    #       --data-urlencode "username=${KEYCLOAK_USERNAME}" \
    #       --data-urlencode "password=${KEYCLOAK_PASSWORD}" \
    #       --data-urlencode "grant_type=password" | jq -r .access_token)

    #     if [ -z "$TOKEN" ] || [ "$TOKEN" = "null" ]; then
    #       echo "Impossible d'obtenir un token"
    #       exit 1
    #     fi

    #     echo "token=$TOKEN" >> $GITHUB_OUTPUT
    #     echo "Token r√©cup√©r√© avec succ√®s"
    #   shell: bash
      # env:
      #   KEYCLOAK_URL: ${{ inputs.keycloak_url }}
      #   KEYCLOAK_USERNAME: ${{ inputs.keycloak_username }}
      #   KEYCLOAK_PASSWORD: ${{ inputs.keycloak_password }}
      #   KEYCLOAK_API_CLIENT_SECRET: ${{ inputs.keycloak_api_client_secret }}

    # -------------------------------------------------------------
    # √âtape 7 : V√©rifie si le realm existe
    # -------------------------------------------------------------
    - name: Check if realm exists
      id: check-realm
      run: |
        STATUS=$(curl -s -o existing_realm.json -w "%{http_code}" \
          -H "Authorization: Bearer ${{ steps.get-token.outputs.token }}" \
          "$KEYCLOAK_URL/admin/realms/$REALM_NAME")

        echo "status=$STATUS" >> $GITHUB_OUTPUT
        echo "Statut du realm : $STATUS"
      shell: bash
      env:
        KEYCLOAK_URL: ${{ inputs.keycloak_url }}

    # -------------------------------------------------------------
    # √âtape 8 : Cr√©er le realm s‚Äôil n‚Äôexiste pas
    # -------------------------------------------------------------
    - name: Create new realm
      if: steps.check-realm.outputs.status == '404'
      run: |
        echo "Cr√©ation du nouveau realm : $REALM_NAME"

        RESPONSE=$(curl -s -w "HTTPSTATUS:%{http_code}" -X POST \
          "$KEYCLOAK_URL/admin/realms" \
          -H "Authorization: Bearer ${{ steps.get-token.outputs.token }}" \
          -H "Content-Type: application/json" \
          --data-binary @"$REALM_FILE")

        HTTP_CODE=$(echo "$RESPONSE" | tr -d '\n' | sed -e 's/.*HTTPSTATUS://')
        BODY=$(echo "$RESPONSE" | sed -e 's/HTTPSTATUS:.*//g')

        if [ "$HTTP_CODE" -eq 201 ] || [ "$HTTP_CODE" -eq 204 ]; then
          echo "Realm cr√©√© avec succ√®s"
        else
          echo "√âchec de la cr√©ation (HTTP $HTTP_CODE)"
          echo "$BODY"
          exit 1
        fi
      shell: bash
      env:
        KEYCLOAK_URL: ${{ inputs.keycloak_url }}

    # -------------------------------------------------------------
    # √âtape 9 : Mettre √† jour le realm existant
    # -------------------------------------------------------------
    - name: Update existing realm
      if: steps.check-realm.outputs.status == '200'
      run: |
        echo "üõ†Ô∏è  Comparaison et mise √† jour du realm existant..."

        jq 'del(.id, .notBefore, .accessTokenLifespan, .ssoSessionIdleTimeout, .ssoSessionMaxLifespan)' existing_realm.json > existing_clean.json
        jq 'del(.id, .notBefore, .accessTokenLifespan, .ssoSessionIdleTimeout, .ssoSessionMaxLifespan)' "$REALM_FILE" > new_clean.json

        if ! diff -q existing_clean.json new_clean.json >/dev/null 2>&1; then
          echo "Diff√©rences d√©tect√©es, mise √† jour en cours..."
          curl -s -X PUT "$KEYCLOAK_URL/admin/realms/$REALM_NAME" \
              -H "Authorization: Bearer ${{ steps.get-token.outputs.token }}" \
              -H "Content-Type: application/json" \
              --data-binary @"$REALM_FILE"
        else
          echo "Aucune modification d√©tect√©e"
        fi
      shell: bash
      env:
        KEYCLOAK_URL: ${{ inputs.keycloak_url }}

    # -------------------------------------------------------------
    # √âtape 10 : V√©rification finale
    # -------------------------------------------------------------
    - name: Verify deployment
      run: |
        STATUS=$(curl -s -w "%{http_code}" -o /dev/null \
          -H "Authorization: Bearer ${{ steps.get-token.outputs.token }}" \
          "$KEYCLOAK_URL/admin/realms/$REALM_NAME")

        if [ "$STATUS" = "200" ]; then
          echo "D√©ploiement v√©rifi√© avec succ√®s : Realm '$REALM_NAME'"
        else
          echo "√âchec de la v√©rification (HTTP $STATUS)"
          exit 1
        fi
      shell: bash
      env:
        KEYCLOAK_URL: ${{ inputs.keycloak_url }}

    # -------------------------------------------------------------
    # √âtape 11 : Nettoyage
    # -------------------------------------------------------------
    - name: Cleanup temporary files
      if: always()
      run: rm -f existing_realm.json existing_clean.json new_clean.json
      shell: bash